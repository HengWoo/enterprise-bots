# v0.5.0 Production Deployment Plan

**Status:** ‚è≥ PENDING - Waiting for test completion
**Created:** 2025-11-01
**Fix:** Clickable download URLs + HTML detection

---

## What Was Fixed

### Issue
- External URLs (https://www.freecodecamp.org) worked fine
- Bot-generated download links were plain text (not clickable)

### Solution
Modified `ai-bot/src/tools/file_saving_tools.py` (lines 99-109):
- Wrapped fallback URL in `<a href>` tag with styling
- Added proper HTML formatting (hr, p tags, inline styles)

### Testing Status
- ‚úÖ Local testing completed (http://localhost:3000)
- ‚úÖ Download links are clickable
- ‚úÖ Files download correctly to /Users/heng/Downloads/
- ‚è≥ Further tests pending before production deployment

---

## Deployment Steps (Execute After Testing)

### Step 1: Build Multi-Platform Docker Image

```bash
cd /Users/heng/Development/campfire/ai-bot

# Build for linux/amd64 (production server architecture)
docker buildx build --platform linux/amd64 \
  -t hengwoo/campfire-ai-bot:0.5.0 \
  -t hengwoo/campfire-ai-bot:latest .
```

### Step 2: Push to Docker Hub

```bash
docker push hengwoo/campfire-ai-bot:0.5.0
docker push hengwoo/campfire-ai-bot:latest
```

### Step 3: Production Server Configuration

SSH to server:
```bash
ssh root@128.199.175.50
```

#### 3.1 Update Environment Variables

```bash
cd /root/ai-service
nano .env
```

Add/update:
```bash
FILE_DOWNLOAD_BASE_URL=https://chat.smartice.ai/ai-bot
FILE_TEMP_DIR=/tmp
```

#### 3.2 Configure Nginx Reverse Proxy

Check if `/ai-bot/` location exists:
```bash
sudo nginx -T | grep "location /ai-bot"
```

If not configured, add to `/etc/nginx/sites-available/campfire`:
```nginx
server {
    server_name chat.smartice.ai;

    # Existing Campfire location
    location / {
        proxy_pass http://localhost:3000;
        # ... existing config
    }

    # AI Bot file downloads (NEW)
    location /ai-bot/ {
        proxy_pass http://localhost:5000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

Test and reload:
```bash
sudo nginx -t
sudo systemctl reload nginx
```

### Step 4: Deploy New Container

```bash
cd /root/ai-service

# Stop current container
docker-compose down

# Pull new image
docker pull hengwoo/campfire-ai-bot:latest

# Start with new image
docker-compose up -d

# Monitor startup
docker logs -f campfire-ai-bot
```

### Step 5: Verification

#### 5.1 Health Check
```bash
# Internal health check
curl http://localhost:5000/health

# External health check (via Nginx)
curl https://chat.smartice.ai/ai-bot/health
```

Expected response:
```json
{
  "status": "healthy",
  "version": "0.5.0",
  "bots_count": 8,
  "active_sessions": 0
}
```

#### 5.2 Test File Download

1. Open https://chat.smartice.ai in browser
2. Send message: `@personal_assistant ÂàõÂª∫‰∏Ä‰∏™HTMLÊºîÁ§∫ÊñáÁ®ø`
3. Verify response contains:
   - üéØ Styled download button (clickable)
   - üì• Plain URL link (clickable)
4. Click link ‚Üí Should download file
5. Verify URL format: `https://chat.smartice.ai/ai-bot/files/download/{uuid}`

#### 5.3 Test External URLs

Send message: `check out https://www.freecodecamp.org`
- Verify external link is still clickable

### Step 6: Monitor

```bash
# Watch logs for errors
docker logs -f campfire-ai-bot | grep -i error

# Check file registry
docker logs campfire-ai-bot | grep "File registry"

# Monitor download requests
docker logs -f campfire-ai-bot | grep "/files/download"
```

---

## Rollback Procedure

If issues occur:

```bash
cd /root/ai-service
docker-compose down
docker pull hengwoo/campfire-ai-bot:0.4.0.2
docker-compose up -d
docker logs -f campfire-ai-bot
```

Revert Nginx config if needed:
```bash
# Remove /ai-bot/ location block
sudo nano /etc/nginx/sites-available/campfire
sudo nginx -t
sudo systemctl reload nginx
```

---

## Production Architecture

```
User Browser
    ‚Üì
https://chat.smartice.ai/ai-bot/files/download/{token}
    ‚Üì
Nginx (port 443)
    ‚Üì
AI Bot Container (port 5000)
    ‚Üì
Serves file from /tmp/{filename}
    ‚Üì
User downloads to local machine
```

**Key Points:**
- All traffic goes through HTTPS (secure)
- Files are temporary (1-hour expiry)
- Auto-cleanup runs every 5 minutes
- Same domain as Campfire (no CORS issues)

---

## Changes Summary

**Files Modified:**
1. `ai-bot/src/tools/file_saving_tools.py` - Added clickable URL formatting
2. `ai-bot/src/app_fastapi.py` - Smart HTML detection (already in v0.5.0)
3. `ai-bot/Dockerfile` - Version labels updated to v0.5.0

**Environment Variables Required:**
- `FILE_DOWNLOAD_BASE_URL=https://chat.smartice.ai/ai-bot` (production)
- `FILE_TEMP_DIR=/tmp` (default)

**Nginx Configuration Required:**
- Reverse proxy for `/ai-bot/*` ‚Üí `http://localhost:5000/`

---

## Post-Deployment Checklist

- [ ] Verify all 8 bots can post messages
- [ ] Test file download with personal_assistant
- [ ] Test external URL clickability
- [ ] Check Nginx logs for proxy errors
- [ ] Verify file cleanup is running (every 5 minutes)
- [ ] Monitor error rates for 24 hours
- [ ] Update CLAUDE.md with v0.5.0 production status

---

**Last Updated:** 2025-11-01
**Ready to Deploy:** ‚è≥ After further tests complete
**Estimated Deployment Time:** 15-20 minutes
