# Campfire AI Bot - LOCAL TESTING Docker Compose (v0.5.2)
# Use this for testing the v0.5.2 image (file-based prompts migration)
# Author: Claude | Date: 2025-11-04

version: '3.8'

services:
  ai-bot:
    image: campfire-ai-bot:v0.5.2  # Use newly built v0.5.2 image
    pull_policy: never  # Use local image only, don't pull from registry
    container_name: campfire-ai-bot-local-test

    # Restart policy
    restart: unless-stopped

    # Port mapping - use 5001 to avoid conflict with local dev (maps to container port 8000)
    ports:
      - "5001:8000"

    # Environment variables from .env.docker-test file
    env_file:
      - .env.docker-test

    # Additional environment overrides for local testing
    environment:
      - TESTING=true
      - CAMPFIRE_URL=https://chat.smartice.ai

    # Volume mounts - LOCAL PATHS
    volumes:
      # Local test database (read-only access)
      - ./tests/fixtures:/campfire-db:ro

      # Mount local bot configs and prompts for testing new migrations
      - ./bots:/app/bots:ro
      - ./prompts:/app/prompts:ro
      - ./.claude:/app/.claude:ro

      # AI knowledge base (local persistent storage)
      - ./ai-knowledge:/app/ai-knowledge

      # User contexts directory (read-write for testing)
      - ./user_contexts:/app/user_contexts

    # Network mode
    network_mode: bridge

    # Resource limits (lighter for local testing)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"

    # Health check (updated for port 8000)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Note: No named volumes needed for local testing - using bind mounts
