# NGINX Configuration for Campfire AI Bot File Downloads
#
# Purpose: Routes file download requests from chat.smartice.ai domain to AI service
# Version: v0.5.3.2
# Date: 2025-11-10
#
# INSTALLATION INSTRUCTIONS:
# 1. SSH to production server: ssh root@128.199.175.50
# 2. Find main nginx config: ls /etc/nginx/sites-available/
# 3. Edit the file for chat.smartice.ai (likely "campfire" or "default")
# 4. Add this location block BEFORE the main "location /" block
# 5. Test: sudo nginx -t
# 6. Reload: sudo systemctl reload nginx
#
# ============================================================================

# File Download Proxy
# Routes https://chat.smartice.ai/files/download/* to AI service on port 5000
location /files/download/ {
    # Proxy to AI service (FastAPI) running in Docker
    proxy_pass http://localhost:5000/files/download/;

    # Preserve original request headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Increase timeouts for large file downloads (5 minutes)
    proxy_read_timeout 300;
    proxy_connect_timeout 300;
    proxy_send_timeout 300;

    # Enable buffering for better performance
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;

    # Optional: Add CORS headers if needed for browser downloads
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods "GET, OPTIONS";
    add_header Access-Control-Allow-Headers "Authorization, Content-Type";
}

# ============================================================================
# EXAMPLE: Complete nginx server block structure
# ============================================================================
#
# server {
#     server_name chat.smartice.ai;
#
#     # SSL configuration (existing from Campfire setup)
#     listen 443 ssl;
#     ssl_certificate /etc/letsencrypt/live/chat.smartice.ai/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/chat.smartice.ai/privkey.pem;
#
#     # File downloads (AI service) - ADD THIS FIRST
#     location /files/download/ {
#         proxy_pass http://localhost:5000/files/download/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_read_timeout 300;
#     }
#
#     # Campfire platform (Rails/ONCE) - EXISTING CONFIGURATION
#     location / {
#         proxy_pass http://localhost:3000;  # Or wherever Campfire runs
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }
#
# ============================================================================

# TROUBLESHOOTING:
#
# 1. Test nginx config syntax:
#    sudo nginx -t
#
# 2. Check nginx error logs:
#    sudo tail -f /var/log/nginx/error.log
#
# 3. Check AI service is running:
#    curl -I http://localhost:5000/health
#
# 4. Test file download endpoint directly:
#    curl -I http://localhost:5000/files/download/test-token
#    # Should return 404 from FastAPI (file not found), not Campfire
#
# 5. Test through nginx:
#    curl -I https://chat.smartice.ai/files/download/test-token
#    # Should also return 404 from FastAPI, proving routing works
#
# 6. View actual download (with real token from bot):
#    curl -L https://chat.smartice.ai/files/download/{real-token} -o /tmp/test-download.html
#
# 7. Check if port 5000 is listening:
#    sudo netstat -tlnp | grep :5000
#    # Should show docker-proxy or similar
#
# ============================================================================
