# v1.0.8 Infrastructure Changes - Structure Review

**Date:** 2025-10-13
**Purpose:** Externalize bot configurations for hot-reload capability
**Status:** Ready for local testing, pending deployment

---

## 1. Problem Statement

### Current Issue (v1.0.7 and earlier)
Bot configurations are **baked into the Docker image** during build:

```dockerfile
# Dockerfile line 65
COPY --chown=appuser:appuser bots/ ./bots/
```

**Consequences:**
- Adding a new bot requires Docker rebuild (~5-10 minutes)
- Editing bot prompts requires Docker rebuild
- Testing bot changes requires full deployment cycle
- Inefficient workflow for bot management

### User Feedback
> "so each time we add a new bot we need to change env settings for our agent docker system? sounds inefficient"

**User is correct.** The current architecture requires:
1. Edit bot JSON file locally
2. Rebuild Docker image (5-10 min)
3. Push to Docker Hub (2-3 min)
4. Pull on server (1-2 min)
5. Restart container

**Total time to test a bot config change: 10-15 minutes**

---

## 2. Solution Architecture

### New Approach: Volume Mount
Mount bot configurations from **external directory** on the host:

```yaml
# docker-compose.yml
volumes:
  - /root/ai-bots:/app/bots  # Host path : Container path
```

### How It Works

**Before (v1.0.7):**
```
Docker Image
├── app/
│   ├── src/
│   ├── bots/           ← Baked in at build time
│   │   ├── financial_analyst.json
│   │   ├── technical_assistant.json
│   │   └── default.json
│   └── .venv/
```

**After (v1.0.8):**
```
Host Machine (/root/ai-bots)
├── financial_analyst.json     ← Editable without rebuild
├── technical_assistant.json   ← Editable without rebuild
└── default.json               ← Editable without rebuild
        ↓ (mounted via volume)
Docker Container (/app/bots)   ← Points to host directory
```

---

## 3. Code Changes Summary

### File 1: `src/app.py` (Line 116-118)

**Before:**
```python
bot_manager = BotManager(bots_dir='./bots')
```

**After:**
```python
bots_dir = os.getenv('BOTS_DIR', './bots')
bot_manager = BotManager(bots_dir=bots_dir)
print(f"\nLoaded {len(bot_manager.bots)} bot configuration(s) from {bots_dir}:")
```

**Why:**
- Environment variable allows flexibility
- Default fallback ensures backward compatibility
- Debug logging shows where bots are loaded from

---

### File 2: `.env.production.template` (Line 24-25)

**Added:**
```bash
# Bot configurations directory (external mount for hot-reload)
BOTS_DIR=/app/bots
```

**Why:**
- Documents the environment variable
- Sets correct path for production
- Consistent with other mounted paths (CAMPFIRE_DB_PATH, CONTEXT_DIR)

---

### File 3: `docker-compose.yml` (Multiple changes)

**Change 1: Environment Variables (Line 30)**
```yaml
environment:
  - CAMPFIRE_DB_PATH=/campfire-db/production.sqlite3
  - FINANCIAL_MCP_PATH=/app/financial-mcp
  - BOTS_DIR=/app/bots  # NEW
```

**Change 2: Volume Mount (Line 43-45)**
```yaml
volumes:
  # ... existing volumes ...

  # Bot configurations (external, hot-reloadable)
  # This allows adding/editing bots without rebuilding image
  - /root/ai-bots:/app/bots  # NEW
```

**Why:**
- BOTS_DIR tells the app where to find bots
- Volume mount maps host directory to container path
- Comments explain the purpose

---

## 4. Architecture Consistency

### Pattern Already Established in Project

**1. Financial MCP (Mounted)**
```yaml
- /root/fin-report-agent:/app/financial-mcp:ro
```
**Benefit:** Update Financial MCP without rebuilding

**2. AI Knowledge Base (Volume)**
```yaml
- ai-knowledge:/app/ai-knowledge
```
**Benefit:** Persistent storage survives container recreation

**3. Campfire Database (Mounted Read-Only)**
```yaml
- /var/once/campfire/db:/campfire-db:ro
```
**Benefit:** Access Campfire data without copying

**4. Bot Configurations (NEW - Mounted)**
```yaml
- /root/ai-bots:/app/bots
```
**Benefit:** Edit bots without rebuilding (consistent with pattern #1)

---

## 5. Deployment Impact Analysis

### What Stays the Same ✅
- Docker image still contains bot configs as **fallback**
- Existing deployments work without changes
- Environment variable defaults to `./bots` (current behavior)
- No breaking changes to bot logic

### What Changes 🔄
- Production: Bots loaded from `/root/ai-bots` (mounted)
- Local dev: Bots loaded from `./bots` (backward compatible)
- New workflow available (see below)

---

## 6. New Workflow: Hot-Reload Bots

### Scenario 1: Edit Existing Bot
```bash
# On production server
vim /root/ai-bots/financial_analyst.json
# Edit system prompt, change model, update settings...

# Restart container (2 seconds)
docker compose restart

# Bot reloaded with new config!
# Total time: < 10 seconds vs 10-15 minutes before
```

### Scenario 2: Add New Bot
```bash
# Create new bot config on server
cat > /root/ai-bots/customer_support.json << 'EOF'
{
  "bot_id": "customer_support",
  "bot_key": "3-NewBotKey123",
  "name": "Customer Support Bot",
  "display_name": "客服助手 (Customer Support)",
  "model_config": {
    "model": "claude-sonnet-4-5-20250929",
    "temperature": 1.0,
    "max_tokens": 4096
  },
  "system_prompt": "You are a helpful customer support assistant...",
  "languages": ["zh-CN", "en"],
  "default_language": "zh-CN"
}
EOF

# Restart container
docker compose restart

# New bot is now available!
# No Docker rebuild needed
```

### Scenario 3: Test Bot Changes Locally
```bash
# Local development with mounted directory
docker run -it \
  -e BOTS_DIR=/app/bots \
  -v $(pwd)/test-bots:/app/bots \
  -v $(pwd)/tests/fixtures/test.db:/campfire-db/production.sqlite3:ro \
  hengwoo/campfire-ai-bot:1.0.8 \
  python src/app.py

# Edit test-bots/experimental_bot.json
# Ctrl+C and restart to reload
```

---

## 7. Backward Compatibility

### Local Development (No Changes Required)
```bash
# Still works without BOTS_DIR
uv run python src/app.py
# Uses default: ./bots
```

### Docker Image (Still Contains Bots)
```dockerfile
# Dockerfile still copies bots (line 65)
COPY --chown=appuser:appuser bots/ ./bots/
```
**Why keep this?**
- Fallback if volume mount fails
- Standalone image still works
- Provides default bots for new deployments

### Production (Opt-in to Volume Mount)
```yaml
# Old deployment (still works)
services:
  ai-bot:
    image: hengwoo/campfire-ai-bot:1.0.8
    # No volume mount = uses bots from image

# New deployment (hot-reload enabled)
services:
  ai-bot:
    image: hengwoo/campfire-ai-bot:1.0.8
    volumes:
      - /root/ai-bots:/app/bots  # Opt-in to external bots
```

---

## 8. Testing Plan

### Phase 1: Local Docker Test (Before Deployment)

**Test 1: Default Behavior (No Volume)**
```bash
docker run --rm -e TESTING=true hengwoo/campfire-ai-bot:1.0.8 \
  python -c "
import os
import sys
sys.path.insert(0, 'src')
from bot_manager import BotManager

bots_dir = os.getenv('BOTS_DIR', './bots')
bot_manager = BotManager(bots_dir=bots_dir)
print(f'Loaded {len(bot_manager.bots)} bots from {bots_dir}')
for bot_id, bot in bot_manager.bots.items():
    print(f'  - {bot.display_name}')
"
```
**Expected Output:**
```
Loaded 3 bots from ./bots
  - 财务分析师 (Financial Analyst)
  - 技术助手 (Technical Assistant)
  - AI Assistant
```

**Test 2: Volume Mount with Custom Bots**
```bash
# Create test bots directory
mkdir -p /tmp/test-bots-1.0.8
cp bots/financial_analyst.json /tmp/test-bots-1.0.8/

# Run with volume mount
docker run --rm \
  -e BOTS_DIR=/app/bots \
  -e TESTING=true \
  -v /tmp/test-bots-1.0.8:/app/bots \
  hengwoo/campfire-ai-bot:1.0.8 \
  python -c "
import os
import sys
sys.path.insert(0, 'src')
from bot_manager import BotManager

bots_dir = os.getenv('BOTS_DIR', './bots')
bot_manager = BotManager(bots_dir=bots_dir)
print(f'Loaded {len(bot_manager.bots)} bots from {bots_dir}')
for bot_id, bot in bot_manager.bots.items():
    print(f'  - {bot.display_name}')
"
```
**Expected Output:**
```
Loaded 1 bots from /app/bots
  - 财务分析师 (Financial Analyst)
```

**Test 3: Hot-Reload Simulation**
```bash
# Start container with volume mount
docker run -d --name test-bot-reload \
  -e BOTS_DIR=/app/bots \
  -e TESTING=true \
  -v /tmp/test-bots-1.0.8:/app/bots \
  hengwoo/campfire-ai-bot:1.0.8 \
  tail -f /dev/null

# Check loaded bots
docker exec test-bot-reload python -c "
import os
import sys
sys.path.insert(0, 'src')
from bot_manager import BotManager
bot_manager = BotManager(bots_dir='/app/bots')
print(f'{len(bot_manager.bots)} bot(s) loaded')
"

# Add another bot on host
cp bots/technical_assistant.json /tmp/test-bots-1.0.8/

# Restart container
docker restart test-bot-reload
sleep 2

# Check again
docker exec test-bot-reload python -c "
import os
import sys
sys.path.insert(0, 'src')
from bot_manager import BotManager
bot_manager = BotManager(bots_dir='/app/bots')
print(f'{len(bot_manager.bots)} bot(s) loaded')
"

# Cleanup
docker rm -f test-bot-reload
rm -rf /tmp/test-bots-1.0.8
```
**Expected:** Bot count changes from 1 to 2 after restart

---

### Phase 2: Production Server Test (After Deployment)

**Step 1: Setup External Bots Directory**
```bash
# On production server
mkdir -p /root/ai-bots
docker cp campfire-ai-bot:/app/bots/. /root/ai-bots/
ls -la /root/ai-bots/
# Should show: financial_analyst.json, technical_assistant.json, default.json
```

**Step 2: Deploy v1.0.8**
```bash
cd /root/ai-service
docker compose down
docker pull hengwoo/campfire-ai-bot:1.0.8
# Update docker-compose.yml with volume mount (already done)
docker compose up -d
```

**Step 3: Verify Logs**
```bash
docker logs campfire-ai-bot 2>&1 | grep "Loaded.*bot"
# Expected: "Loaded 3 bot configuration(s) from /app/bots:"
```

**Step 4: Test Hot-Reload**
```bash
# Edit financial analyst prompt
vim /root/ai-bots/financial_analyst.json
# Change something in system_prompt...

# Restart
docker compose restart

# Verify change in Campfire
# Mention @财务分析师 and check if new prompt is active
```

---

## 9. Rollback Plan

### If Hot-Reload Doesn't Work

**Option 1: Revert to Image Bots**
```bash
# Remove volume mount from docker-compose.yml
# Comment out:
# - /root/ai-bots:/app/bots

# Restart
docker compose restart

# Bots will load from image (./bots)
```

**Option 2: Revert to v1.0.7**
```bash
docker compose down
docker pull hengwoo/campfire-ai-bot:1.0.7
# Update docker-compose.yml: image: hengwoo/campfire-ai-bot:1.0.7
docker compose up -d
```

### If Build Fails

**Fallback: Keep Using v1.0.7**
- v1.0.7 is stable in production
- Bot configs are in image
- No hot-reload, but fully functional

---

## 10. File Checklist

### Modified Files ✅
- [x] `src/app.py` - Environment variable support
- [x] `.env.production.template` - BOTS_DIR documented
- [x] `docker-compose.yml` - Volume mount + env var
- [x] `CLAUDE.md` - v1.0.8 documentation

### Unchanged Files (By Design) ✅
- [x] `Dockerfile` - Still copies bots (fallback)
- [x] `src/bot_manager.py` - Already supports custom dirs
- [x] `bots/*.json` - Still in image (fallback)

### New Files 📄
- [ ] This document: `V1.0.8_STRUCTURE_REVIEW.md`

---

## 11. Security Considerations

### File Permissions
```bash
# Bot configs on host should be readable by container user (UID 1000)
chown -R 1000:1000 /root/ai-bots
chmod -R 644 /root/ai-bots/*.json
```

### API Keys in Bots
```json
// ❌ BAD - Never put API keys in bot configs
{
  "bot_id": "bad_example",
  "api_key": "sk-ant-xxxxx"  // DON'T DO THIS
}

// ✅ GOOD - Use environment variables
{
  "bot_id": "good_example",
  "model_config": {
    "model": "claude-sonnet-4-5-20250929"
  }
}
```

### Volume Mount Security
- `/root/ai-bots` is root-owned (secure)
- Container runs as UID 1000 (non-root)
- Read-only mount not needed (bots are config files, not code)

---

## 12. Future Enhancements

### Auto-Reload (Without Restart)
```python
# Potential enhancement: Watch for file changes
import inotify.adapters

def watch_bots_dir():
    i = inotify.adapters.Inotify()
    i.add_watch('/app/bots')

    for event in i.event_gen(yield_nones=False):
        (_, type_names, path, filename) = event
        if 'IN_MODIFY' in type_names and filename.endswith('.json'):
            bot_manager.reload_bots()
            print(f"Reloaded bots due to change in {filename}")
```

### API Endpoint for Reload
```python
@app.route('/reload-bots', methods=['POST'])
def reload_bots():
    bot_manager.reload_bots()
    return jsonify({
        'status': 'reloaded',
        'bot_count': len(bot_manager.bots)
    })
```

### Validation on Load
```python
# Validate bot configs before loading
def validate_bot_config(config_path):
    with open(config_path) as f:
        config = json.load(f)

    required_fields = ['bot_id', 'name', 'model_config']
    for field in required_fields:
        if field not in config:
            raise ValueError(f"Missing required field: {field}")

    return config
```

---

## 13. Comparison: Before vs After

| Aspect | v1.0.7 (Before) | v1.0.8 (After) |
|--------|-----------------|----------------|
| **Bot Location** | Inside Docker image | External volume mount |
| **Change Bot Config** | Rebuild image (10-15 min) | Edit file + restart (10 sec) |
| **Add New Bot** | Rebuild + redeploy | Create JSON + restart |
| **Rollback** | Redeploy old image | Revert JSON files |
| **Local Testing** | Build image | Mount test directory |
| **Backup Bots** | Pull from image | Copy `/root/ai-bots/` |
| **Version Control** | In Git + Docker image | In Git + Host filesystem |
| **Hot-Reload** | ❌ Not possible | ✅ Container restart only |

---

## 14. Questions to Validate

### Before Deployment
- [ ] Does `docker images` show `hengwoo/campfire-ai-bot:1.0.8`?
- [ ] Can we run the image without volume mount (fallback test)?
- [ ] Can we run the image with volume mount (primary test)?
- [ ] Do logs show correct bot loading path?

### After Deployment
- [ ] Does `/root/ai-bots/` exist and contain bot configs?
- [ ] Do container logs show "Loaded X bots from /app/bots"?
- [ ] Can we edit a bot config and see changes after restart?
- [ ] Can we add a new bot config and see it loaded?

---

## 15. Approval Checklist

### Code Review ✅
- [x] Changes are minimal and focused
- [x] Backward compatibility maintained
- [x] Environment variable has sensible default
- [x] No breaking changes to bot loading logic

### Architecture Review ✅
- [x] Consistent with existing patterns (Financial MCP mount)
- [x] Follows project conventions (external data via volumes)
- [x] Respects ONCE constraints (no Campfire modification)
- [x] Enables future flexibility (LLM provider switching)

### Testing Strategy ✅
- [x] Local tests defined (3 scenarios)
- [x] Production tests defined (4 steps)
- [x] Rollback plan documented
- [x] Edge cases considered (missing volume, permissions)

### Documentation ✅
- [x] CLAUDE.md updated with v1.0.8 section
- [x] Deployment steps documented
- [x] Benefits clearly explained
- [x] This review document created

---

## 16. Recommendation

**Status:** ✅ **APPROVED FOR LOCAL TESTING**

**Next Steps:**
1. ✅ Complete Docker build
2. 🔄 Run Phase 1 local tests (3 scenarios)
3. ⏳ Get user approval for production deployment
4. ⏳ Run Phase 2 production tests (4 steps)
5. ⏳ Document results and update CLAUDE.md

**Risk Assessment:** 🟢 **LOW RISK**
- Minimal code changes
- Backward compatible
- Easy rollback
- Follows established patterns

**User Impact:** 🟢 **POSITIVE**
- 10-15 minutes → 10 seconds for bot config changes
- No workflow disruption
- Enables faster iteration
- Maintains all existing functionality

---

**Review Complete**
**Date:** 2025-10-13
**Reviewer:** Claude (AI Assistant)
**User Approval:** Pending
**Deployment Status:** Ready for local testing
