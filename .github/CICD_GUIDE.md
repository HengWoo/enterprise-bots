# CI/CD Pipeline Guide

**Repository:** HengWoo/enterprise-bots
**Docker Hub:** hengwoo/campfire-ai-bot
**Production:** DigitalOcean (128.199.175.50) â†’ https://chat.smartice.ai

---

## Overview

This project uses GitHub Actions for automated CI/CD with three workflows:

1. **Build and Test** - Automatic on pull requests
2. **Build and Push** - Manual trigger to build and push Docker images
3. **Deploy to Production** - Manual trigger with approval gate to deploy

---

## Prerequisites

Before using the CI/CD pipeline, you must configure the following secrets and settings.

### 1. Docker Hub Access Token

**Create token:**
1. Go to https://hub.docker.com/settings/security
2. Click "New Access Token"
3. Description: `GitHub Actions CI/CD`
4. Permissions: Read, Write, Delete
5. Click "Generate"
6. **COPY THE TOKEN IMMEDIATELY** (format: `dckr_pat_xxxxxxxx`)

### 2. GitHub Repository Secrets

**Add secrets:**
1. Go to https://github.com/HengWoo/enterprise-bots/settings/secrets/actions
2. Click "New repository secret"
3. Add the following secrets:

| Secret Name | Value | Description |
|-------------|-------|-------------|
| `DOCKERHUB_USERNAME` | `hengwoo` | Docker Hub username |
| `DOCKERHUB_TOKEN` | `dckr_pat_...` | Token from step 1 |
| `DO_SSH_KEY` | `-----BEGIN OPENSSH PRIVATE KEY-----...` | Private SSH key for DigitalOcean |
| `DO_HOST` | `128.199.175.50` | DigitalOcean server IP |
| `DO_USER` | `root` | SSH user |

### 3. GitHub Environment Setup

**Create production environment:**
1. Go to https://github.com/HengWoo/enterprise-bots/settings/environments
2. Click "New environment"
3. Name: `production`
4. Configure protection rules:
   - âœ… Required reviewers: Add yourself
   - Number of reviewers: 1
   - Wait timer: 0 minutes (optional)
5. Click "Save protection rules"

### 4. DigitalOcean SSH Key Setup

**Generate new SSH key for CI/CD:**
```bash
# On your local machine
ssh-keygen -t ed25519 -C "github-actions-cicd" -f ~/.ssh/github-actions

# Copy public key to server
ssh-copy-id -i ~/.ssh/github-actions.pub root@128.199.175.50

# Copy private key content for GitHub Secret
cat ~/.ssh/github-actions
# Copy entire output including "-----BEGIN OPENSSH PRIVATE KEY-----"
```

**Add public key to server manually:**
```bash
# SSH to server
ssh root@128.199.175.50

# Add public key
mkdir -p ~/.ssh
echo "ssh-ed25519 AAAAC3... github-actions-cicd" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# Test from local machine
ssh -i ~/.ssh/github-actions root@128.199.175.50 "echo 'SSH works!'"
```

---

## Workflow 1: Build and Test (Automatic)

**Trigger:** Automatically on pull requests to `main` branch

**Purpose:** Verify code builds correctly before merging

**What it does:**
1. Checks out code
2. Builds Docker image for linux/amd64
3. Runs container with test configuration
4. Checks health endpoint
5. Comments on PR with build status

**Example PR comment:**
```
## âœ… Build Status

**Result:** Build passed!

**Commit:** a1b2c3d
**Workflow:** View logs

---
ðŸ¤– Generated by GitHub Actions
```

**If build fails:**
- âŒ PR cannot be merged until fixed
- Check workflow logs for error details
- Fix issues and push new commits
- Build will run again automatically

---

## Workflow 2: Build and Push to Docker Hub (Manual)

**Trigger:** Manual via GitHub Actions UI

**Purpose:** Build Docker image and push to Docker Hub

### How to Use

**Step 1: Navigate to Actions**
```
GitHub Repository â†’ Actions tab â†’ "Build and Push to Docker Hub"
```

**Step 2: Click "Run workflow"**
- Select branch: `main`
- Enter version: `v0.4.1` (format: vX.Y.Z)
- Push as latest: âœ… (checked)

**Step 3: Click "Run workflow"**

**Step 4: Monitor progress**
- Watch live logs in Actions tab
- Workflow takes ~5-10 minutes

**Step 5: Verify success**
- Check Docker Hub: https://hub.docker.com/r/hengwoo/campfire-ai-bot/tags
- Tags created:
  - `v0.4.1`
  - `0.4.1`
  - `latest`

**Step 6: GitHub Release created automatically**
- Go to: Releases tab
- Release `v0.4.1` created with deployment instructions

### What This Workflow Does

```
1. Checkout code
2. Setup Docker Buildx
3. Login to Docker Hub (using secrets)
4. Validate version format (must be vX.Y.Z)
5. Build Docker image:
   - Platform: linux/amd64
   - Context: ./ai-bot
   - Dockerfile: ./ai-bot/Dockerfile
6. Tag image:
   - hengwoo/campfire-ai-bot:v0.4.1
   - hengwoo/campfire-ai-bot:0.4.1
   - hengwoo/campfire-ai-bot:latest (if selected)
7. Push to Docker Hub
8. Create GitHub Release with deployment instructions
```

### Troubleshooting

**Error: "Docker Hub login failed"**
```
Solution:
1. Check DOCKERHUB_USERNAME secret is correct
2. Check DOCKERHUB_TOKEN secret is valid
3. Token may have expired - generate new one
4. Update GitHub Secret with new token
```

**Error: "Invalid version format"**
```
Solution:
Version must match format: vX.Y.Z
Examples:
  âœ… v0.4.1
  âœ… v1.0.0
  âŒ 0.4.1 (missing 'v')
  âŒ v0.4 (missing patch version)
```

**Error: "Build failed"**
```
Solution:
1. Check Dockerfile syntax
2. Verify all dependencies in pyproject.toml
3. Test build locally first:
   cd ai-bot
   docker build -t test .
4. Fix errors and retry workflow
```

---

## Workflow 3: Deploy to Production (Manual + Approval)

**Trigger:** Manual via GitHub Actions UI (requires approval)

**Purpose:** Deploy Docker image to production server

### How to Use

**Step 1: Navigate to Actions**
```
GitHub Repository â†’ Actions tab â†’ "Deploy to Production"
```

**Step 2: Click "Run workflow"**
- Select branch: `main`
- Enter version: `v0.4.1` or `latest`
- Skip backup: âŒ (unchecked - always backup)

**Step 3: Click "Run workflow"**

**Step 4: Wait for approval request**
- Deployment pauses for manual approval
- You'll receive notification (email/GitHub)
- Review deployment details

**Step 5: Review and approve**
```
Deployment Details:
  Environment: production
  Version: v0.4.1
  URL: https://chat.smartice.ai

Actions:
  âœ… Review deployments
  âœ… Approve and deploy
  âŒ Reject
```

**Step 6: Monitor deployment**
- Watch live logs
- Deployment takes ~2-3 minutes
- Health checks run automatically

**Step 7: Verify success**
- Check health endpoint: `curl http://128.199.175.50:5000/health`
- Test bots in Campfire: https://chat.smartice.ai
- Monitor logs: `docker logs -f campfire-ai-bot`

### What This Workflow Does

```
1. Checkout code
2. Setup SSH connection to production server
3. Verify server connectivity
4. Backup current deployment (optional):
   - AI knowledge base â†’ /root/backups/deployments/TIMESTAMP/
   - AI service config â†’ /root/backups/deployments/TIMESTAMP/
5. Pull Docker image from Docker Hub
6. Deploy AI Bot:
   - Stop current container (graceful shutdown)
   - Update docker-compose.yml with new version
   - Start new container
   - Wait for container to be ready (15 seconds)
7. Health check:
   - Verify container is running
   - Check health endpoint (10 attempts, 5s interval)
   - Test webhook response
8. On success: Post deployment summary
9. On failure: Automatic rollback to v0.4.0.2
```

### Deployment Flow Diagram

```
Developer                    GitHub Actions                  Production Server
    â”‚                              â”‚                               â”‚
    â”œâ”€ Run workflow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                               â”‚
    â”‚                              â”‚                               â”‚
    â”‚                              â”œâ”€ Wait for approval           â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€ Approval request â”€â”€â”€â”€â”¤                               â”‚
    â”‚                              â”‚                               â”‚
    â”œâ”€ Approve â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                               â”‚
    â”‚                              â”‚                               â”‚
    â”‚                              â”œâ”€ SSH connect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                              â”‚                               â”‚
    â”‚                              â”‚<â”€â”€â”€â”€ SSH connection OK â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                              â”‚                               â”‚
    â”‚                              â”œâ”€ Backup current deployment â”€â”€>â”‚
    â”‚                              â”‚                               â”‚
    â”‚                              â”‚<â”€â”€â”€â”€ Backup complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                              â”‚                               â”‚
    â”‚                              â”œâ”€ Pull Docker image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                              â”‚                               â”‚
    â”‚                              â”‚<â”€â”€â”€â”€ Image pulled â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                              â”‚                               â”‚
    â”‚                              â”œâ”€ Deploy new version â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                              â”‚                               â”‚
    â”‚                              â”‚<â”€â”€â”€â”€ Container running â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                              â”‚                               â”‚
    â”‚                              â”œâ”€ Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                              â”‚                               â”‚
    â”‚                              â”‚<â”€â”€â”€â”€ Health OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                              â”‚                               â”‚
    â”‚<â”€â”€â”€â”€â”€ Deployment success â”€â”€â”€â”€â”¤                               â”‚
```

### Troubleshooting

**Error: "SSH connection failed"**
```
Solution:
1. Check DO_SSH_KEY secret is correct
2. Check DO_HOST and DO_USER secrets
3. Verify SSH key added to server:
   ssh root@128.199.175.50 "cat ~/.ssh/authorized_keys"
4. Test SSH manually:
   ssh -i ~/.ssh/github-actions root@128.199.175.50
```

**Error: "Docker pull failed"**
```
Solution:
1. Verify image exists on Docker Hub
2. Check version tag is correct
3. Network connectivity issue - retry workflow
```

**Error: "Health check failed"**
```
Solution:
1. Check deployment logs:
   ssh root@128.199.175.50
   docker logs --tail 50 campfire-ai-bot
2. Common issues:
   - Missing environment variables in .env
   - Campfire database not accessible
   - API key invalid
3. Fix issues and retry deployment
```

**Error: "Deployment failed, rollback initiated"**
```
What happens:
1. Workflow automatically stops failed container
2. Pulls stable version (v0.4.0.2)
3. Starts stable version
4. Production service restored

Next steps:
1. Investigate failure logs
2. Fix issues locally
3. Test with local environment (docker-compose.dev.yml)
4. Retry deployment after fixing
```

---

## Best Practices

### Version Numbering

Follow semantic versioning (vX.Y.Z):
- **Major (X)**: Breaking changes (e.g., v1.0.0 â†’ v2.0.0)
- **Minor (Y)**: New features, backward-compatible (e.g., v0.4.0 â†’ v0.5.0)
- **Patch (Z)**: Bug fixes, backward-compatible (e.g., v0.4.0 â†’ v0.4.1)

**Examples:**
- v0.4.1 â†’ Bug fix release
- v0.5.0 â†’ New feature (file download system)
- v1.0.0 â†’ Major stable release

### Deployment Checklist

**Before triggering "Build and Push":**
- [ ] All tests passed locally
- [ ] Code reviewed and approved
- [ ] Version number decided (vX.Y.Z)
- [ ] CLAUDE.md and DESIGN.md updated
- [ ] No breaking changes (or documented)

**Before triggering "Deploy to Production":**
- [ ] Image pushed to Docker Hub successfully
- [ ] GitHub Release created
- [ ] Tested with local environment (docker-compose.dev.yml)
- [ ] Deployment plan reviewed
- [ ] Backup strategy confirmed
- [ ] Rollback plan understood

**After deployment:**
- [ ] Health check passed
- [ ] Test all 8 bots in Campfire
- [ ] Monitor logs for 15-30 minutes
- [ ] Check error rates
- [ ] Verify no regressions

### Monitoring After Deployment

**First 30 minutes:**
```bash
# SSH to production server
ssh root@128.199.175.50

# Watch logs in real-time
docker logs -f campfire-ai-bot

# Look for:
# âœ… "Loaded bot: ..." (all 8 bots)
# âœ… "Processing webhook..." (bots responding)
# âŒ Errors, exceptions, crashes
```

**First 24 hours:**
- Check logs periodically
- Test each bot with real queries
- Monitor API usage/costs
- Watch for performance issues

**First week:**
- Daily log checks
- User feedback monitoring
- Performance metrics review
- Bug reports triage

---

## Rollback Procedures

### Manual Rollback (Recommended)

If automated rollback fails or you need to rollback manually:

```bash
# SSH to production server
ssh root@128.199.175.50

# Navigate to service directory
cd /root/ai-service

# Stop current container
docker-compose down

# Pull stable version
docker pull hengwoo/campfire-ai-bot:v0.4.0.2

# Update docker-compose.yml
sed -i 's|image: hengwoo/campfire-ai-bot:.*|image: hengwoo/campfire-ai-bot:v0.4.0.2|' docker-compose.yml

# Start stable version
docker-compose up -d

# Verify
curl http://localhost:5000/health
docker logs --tail 50 campfire-ai-bot
```

### Restore from Backup

If service is corrupted and needs full restore:

```bash
# Find latest backup
ls -lt /root/backups/deployments/

# Restore AI knowledge base
cd /root
tar -xzf /root/backups/deployments/YYYYMMDD_HHMMSS/ai-knowledge.tar.gz

# Restore AI service config
tar -xzf /root/backups/deployments/YYYYMMDD_HHMMSS/ai-service-config.tar.gz

# Restart service
cd /root/ai-service
docker-compose restart
```

---

## Security Best Practices

### Secrets Management

- âœ… Never commit secrets to repository
- âœ… Use GitHub Secrets for sensitive data
- âœ… Rotate tokens every 3-6 months
- âœ… Use separate SSH keys for CI/CD
- âœ… Limit SSH key permissions (no password sudo)

### Access Control

- âœ… Require approval for production deployments
- âœ… Limit who can approve deployments
- âœ… Enable branch protection on main
- âœ… Require PR reviews before merge
- âœ… Use least-privilege Docker Hub tokens

### Audit Trail

All deployments are logged:
- GitHub Actions logs (90 days retention)
- Commit comments on deployments
- Server logs: `/var/log/syslog`
- Docker logs: `docker logs campfire-ai-bot`

---

## Common Scenarios

### Scenario 1: Hotfix Deployment

```
Issue discovered in production â†’ Urgent fix needed

Steps:
1. Create hotfix branch: git checkout -b hotfix/critical-bug
2. Fix bug and test locally
3. Open PR to main
4. Wait for build-and-test âœ…
5. Merge PR
6. Actions â†’ Build and Push â†’ Version: v0.4.0.3
7. Wait for build complete âœ…
8. Actions â†’ Deploy to Production â†’ Version: v0.4.0.3
9. Approve deployment
10. Monitor logs closely
```

### Scenario 2: Feature Release

```
New feature complete â†’ Ready to deploy

Steps:
1. Ensure feature branch merged to main
2. Update CLAUDE.md with new version
3. Actions â†’ Build and Push â†’ Version: v0.5.0
4. Wait for build complete âœ…
5. Test with local environment (docker-compose.dev.yml)
6. Actions â†’ Deploy to Production â†’ Version: v0.5.0
7. Approve deployment
8. Monitor for 24-48 hours
```

### Scenario 3: Rollback After Bad Deploy

```
Deployment succeeded but production has issues

Steps:
1. Identify issue (logs, health checks, user reports)
2. Decision: Fix forward or rollback?
3. If rollback:
   - Actions â†’ Deploy to Production â†’ Version: v0.4.0.2
   - Approve deployment (this is the rollback)
   - Verify stable version running
4. Investigate root cause
5. Fix locally
6. Test thoroughly
7. Redeploy with fixed version
```

---

## Quick Reference Commands

### Local Testing
```bash
cd /Users/heng/Development/campfire
docker-compose -f docker-compose.dev.yml up
```

### Build Locally
```bash
cd /Users/heng/Development/campfire/ai-bot
docker build -t campfire-ai-bot:test .
```

### SSH to Production
```bash
ssh root@128.199.175.50
```

### Check Production Status
```bash
# Health check
curl http://128.199.175.50:5000/health

# Container status
ssh root@128.199.175.50 "docker ps | grep campfire-ai-bot"

# Logs
ssh root@128.199.175.50 "docker logs --tail 50 campfire-ai-bot"
```

### Manual Docker Hub Push (if CI/CD unavailable)
```bash
# Build for linux/amd64
docker buildx build --platform linux/amd64 \
  -t hengwoo/campfire-ai-bot:v0.4.1 \
  -t hengwoo/campfire-ai-bot:latest \
  ./ai-bot

# Push
docker push hengwoo/campfire-ai-bot:v0.4.1
docker push hengwoo/campfire-ai-bot:latest
```

---

## Support

**Documentation:**
- CI/CD Guide: `.github/CICD_GUIDE.md` (this file)
- Implementation Plan: `IMPLEMENTATION_PLAN.md`
- Architecture: `DESIGN.md`
- Project Memory: `CLAUDE.md`

**Workflow Files:**
- Build and Test: `.github/workflows/build-and-test.yml`
- Build and Push: `.github/workflows/build-and-push.yml`
- Deploy Production: `.github/workflows/deploy-production.yml`

**Useful Links:**
- GitHub Actions: https://github.com/HengWoo/enterprise-bots/actions
- Docker Hub: https://hub.docker.com/r/hengwoo/campfire-ai-bot
- Production: https://chat.smartice.ai

---

**Last Updated:** 2025-10-27
**Version:** 1.0
**Status:** Ready for Production Use âœ…
