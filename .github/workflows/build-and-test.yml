name: Build and Test

on:
  pull_request:
    branches:
      - main
    paths:
      - 'ai-bot/**'
      - '.github/workflows/build-and-test.yml'

jobs:
  build-test:
    name: Build Docker Image and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./ai-bot
          file: ./ai-bot/Dockerfile
          platforms: linux/amd64
          push: false
          load: true
          tags: campfire-ai-bot:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test - Run health check
        run: |
          # Start container with minimal environment
          docker run -d \
            --name campfire-ai-bot-test \
            -p 8000:5000 \
            -e TESTING=true \
            -e ANTHROPIC_API_KEY=test-key-for-build \
            campfire-ai-bot:test

          # Wait for container to be ready
          echo "Waiting for container to start..."
          sleep 10

          # Check if container is still running
          if ! docker ps | grep -q campfire-ai-bot-test; then
            echo "‚ùå Container failed to start"
            docker logs campfire-ai-bot-test
            exit 1
          fi

          # Check health endpoint
          echo "Testing health endpoint..."
          for i in {1..5}; do
            if curl -f http://localhost:8000/health; then
              echo "‚úÖ Health check passed"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done

          echo "‚ùå Health check failed after 5 attempts"
          docker logs campfire-ai-bot-test
          exit 1

      - name: Cleanup
        if: always()
        run: |
          docker stop campfire-ai-bot-test || true
          docker rm campfire-ai-bot-test || true

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => {
              return comment.user.type === 'Bot' && comment.body.includes('Build Status')
            });

            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            const message = status === 'success' ? 'Build passed!' : 'Build failed. Check logs for details.';

            const body = `## ${emoji} Build Status

            **Result:** ${message}

            **Commit:** ${context.sha}
            **Workflow:** [View logs](${context.payload.repository.html_url}/actions/runs/${context.runId})

            ---
            <sub>ü§ñ Generated by GitHub Actions</sub>`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
